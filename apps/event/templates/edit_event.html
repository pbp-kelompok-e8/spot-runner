{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Event</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<main class="mt-16 py-8 bg-white text-gray-900">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-4">
            <a href="javascript:history.back()" class="text-sm font-medium text-gray-700 hover:text-gray-900">
                &lt; Back
            </a>
        </div>
        <input type="hidden" name="next" value="{{ request.GET.next }}">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md hover:shadow-lg transition duration-300">
            <form id="edit-event-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.GET.next }}">
                <div class="text-center mb-1">
                    <h1 class="text-2xl font-semibold text-gray-900">Edit Your Event</h1>
                </div>

                <div id="form-errors-container" class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded" style="display: none;">
                    <p class="font-bold">Please correct the errors below</p>
                    <ul id="form-errors-list" class="list-disc list-inside">
                        </ul>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <div class="flex flex-wrap gap-3">
                        {% for value, text in form.fields.event_status.choices %}
                        <div>
                            <input type="radio" id="status-{{ value }}" name="event_status" value="{{ value }}" 
                                   class="sr-only peer" {% if form.event_status.value == value or not form.event_status.value and value == 'coming_soon' %}checked{% endif %}>
                            <label for="status-{{ value }}" 
                                   class="
                                       py-1 px-4 rounded-full text-xs font-semibold cursor-pointer transition 
                                       {% if value == 'coming_soon' %} bg-yellow-100 text-yellow-800 peer-checked:ring-yellow-500 {% endif %}
                                       {% if value == 'finished' %} bg-green-100 text-green-800 peer-checked:ring-green-500 {% endif %}
                                       {% if value == 'on_going' %} bg-blue-100 text-blue-800 peer-checked:ring-blue-500 {% endif %}
                                       peer-checked:ring-2 peer-checked:ring-offset-2 
                                   ">
                                {{ text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="error-event_status" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Event Name
                    </label>
                    {{ form.name }}
                    <div id="error-name" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    {{ form.description }}
                    <div id="error-description" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Location
                    </label>
                    {{ form.location }}
                    <div id="error-location" class="mt-1 text-xs text-red-600"></div>
                </div>
                
                <div class="mb-5">
                    <label for="{{ form.event_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Event Date
                    </label>
                    {{ form.event_date }}
                    <div id="error-event_date" class="mt-1 text-xs text-red-600"></div>
                </div>
                
                <div class="mb-5">
                    <label for="{{ form.regist_deadline.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Registration Deadline
                    </label>
                    {{ form.regist_deadline }}
                    <div id="error-regist_deadline" class="mt-1 text-xs text-red-600"></div>
                </div>
                
                <div class="mb-5">
                    <label for="{{ form.contact.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Contact Person
                    </label>
                    {{ form.contact }}
                    <div id="error-contact" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.capacity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Max Participants
                    </label>
                    {{ form.capacity }}
                    <div id="error-capacity" class="mt-1 text-xs text-red-600"></div>
                </div>
                
                <div class="mb-5">
                    <label for="{{ form.coin.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Coin Reward
                    </label>
                    {{ form.coin }}
                    <div id="error-coin" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Category</label>
                    <div class="space-y-2">
                        {% for choice in form.event_category %}
                        <div class="flex items-center">
                            {{ choice.tag }} 
                            <label for="{{ choice.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                                {{ choice.choice_label }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="error-event_category" class="mt-1 text-xs text-red-600"></div>
                </div>
                
                <div class="mb-5">
                    <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Image URL 1
                    </label>
                    {{ form.image }}
                    <div id="error-image" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.image2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Image URL 2
                    </label>
                    {{ form.image2 }}
                    <div id="error-image2" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.image3.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Image URL 3
                    </label>
                    {{ form.image3 }}
                    <div id="error-image3" class="mt-1 text-xs text-red-600"></div>
                </div>

                <div class="mt-6">
                    <button type="submit" id="submit-button"
                            class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Edit Event
                    </button>
                </div>

            </form>
        </div>
    </div>
</main>

<!-- Toast Confirmation -->
<div id="confirmToast" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
    <div class="bg-white rounded-xl shadow-xl p-6 w-[380px] text-center animate-fadeIn">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Are you sure you want to save changes?</h2>
        <p class="text-gray-500 mb-6 text-sm">
            Please review your event details before saving.
        </p>
        <div class="flex justify-center gap-3">
            <button id="cancelToast" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">
                Cancel
            </button>
            <button id="confirmToastYes" class="px-4 py-2 rounded-lg bg-lime-500 hover:bg-lime-600 text-white font-medium">
                Yes, I'm sure
            </button>
        </div>
    </div>
</div>

{% include 'footer.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-event-form');
    const submitButton = document.getElementById('submit-button');
    const errorContainer = document.getElementById('form-errors-container');
    const errorList = document.getElementById('form-errors-list');
    const toast = document.getElementById('confirmToast');
    const btnCancel = document.getElementById('cancelToast');
    const btnYes = document.getElementById('confirmToastYes');

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        toast.classList.remove('hidden');
    });

    btnCancel.addEventListener('click', function() {
        toast.classList.add('hidden');
    });

    btnYes.addEventListener('click', async function() {
        toast.classList.add('hidden');
        
        submitButton.disabled = true;
        submitButton.textContent = 'Editing...';
        errorContainer.style.display = 'none';
        errorList.innerHTML = '';
        
        // Clear individual field errors
        document.querySelectorAll('[id^="error-"]').forEach(el => {
            el.innerHTML = '';
        });

        const formData = new FormData(form);
        
        try {
            const response = await fetch(window.location.pathname, { 
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Event updated successfully!', true);
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1000);
            } else {
                errorContainer.style.display = 'block';
                
                // Handle general errors
                if (data.errors['__all__']) {
                    data.errors['__all__'].forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error.message;
                        errorList.appendChild(li);
                    });
                }

                // Handle field-specific errors
                Object.keys(data.errors).forEach(field => {
                    if (field !== '__all__') {
                        const errorDiv = document.getElementById(`error-${field}`);
                        
                        // Add to general error list
                        data.errors[field].forEach(error => {
                            const li = document.createElement('li');
                            li.textContent = `${field.replace('_', ' ')}: ${error.message}`;
                            errorList.appendChild(li);
                        });
                        
                        // Add to individual field error display
                        if (errorDiv) {
                            data.errors[field].forEach(error => {
                                const p = document.createElement('p');
                                p.textContent = error.message;
                                errorDiv.appendChild(p);
                            });
                        }
                    }
                });
                
                showToast('Please correct the errors below.', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An unexpected error occurred. Please try again.', false);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Edit Event';
        }
    });

    // Function: Small toast notification (top right)
    function showToast(message, success = true) {
        const toast = document.createElement("div");
        toast.className =
            "fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 transition-opacity duration-300 " +
            (success ? "bg-green-500" : "bg-red-500");

        toast.textContent = message;
        document.body.appendChild(toast);

        // Animasi fade-in/out biar smooth
        toast.style.opacity = 0;
        setTimeout(() => (toast.style.opacity = 1), 50);
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock content %}