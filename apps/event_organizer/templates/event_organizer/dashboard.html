{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Dashboard</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex flex-col bg-gray-50">

    <!-- === KONTEN UTAMA === -->
    <main class="flex-grow">
        <div class="max-w-7xl mx-auto px-6 py-8 space-y-10 pt-20">
            <!-- === BAGIAN ATAS (PROFILE + RATING DALAM SATU CARD) === -->
            <div class="bg-white shadow rounded-xl border p-8 space-y-6">

                <!-- Profile Header -->
                <div class="flex justify-between items-center">

                    <div class="flex items-center space-x-5">
                        <!-- Profile Picture -->
                        {% if organizer.profile_picture %}
                            <img src="{{ organizer.profile_picture }}" class="w-20 h-20 object-cover rounded-full border">
                        {% else %}
                            <img src="{% static 'images/logo-img.png' %}" class="w-20 h-20 object-cover rounded-full border">
                        {% endif %}

                        
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-gray-600">

                            <div>
                                <p class="text-sm text-gray-500">Event Organizer</p>
                                <h1 class="text-4xl font-semibold text-gray-800">{{ organizer.name }}</h1>

                                <div class="mt-2 text-sm text-gray-600 space-y-1">
                                    <p>ğŸŸï¸ Total Events: <span class="font-medium">{{ total_events }}</span></p>
                                    <p>ğŸ“… Joined: <span class="font-medium">{{ organizer.created_at|date:"d M Y" }}</span></p>
                                    <p>ğŸ“ Base Location: <span class="font-medium">{{ organizer.get_base_location_display|default:"-" }}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Events Box -->
                    <div class="bg-gray-50 border rounded-lg w-32 h-24 flex flex-col justify-center items-center">
                        <p class="text-3xl font-bold">{{ total_events }}</p>
                        <p class="text-sm text-gray-600">Events</p>
                    </div>

                </div>

                <!-- Divider -->
                <hr class="border-gray-200" />

                <!-- Review & Rating Section -->
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Review & Rating</h2>

                    <div class="flex items-center gap-3 text-gray-800">
                        <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.955a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.372 2.453a1 1 0 00-.364 1.118l1.286 3.955c.3.921-.755 1.688-1.54 1.118L10 14.347l-3.377 2.479c-.784.57-1.838-.197-1.539-1.118l1.285-3.955a1 1 0 00-.364-1.118L3.63 9.382c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69l1.286-3.955z"/>
                        </svg>

                        <p class="text-xl font-semibold">
                            {{ organizer_average_rating|default:"0.0" }}
                            <span class="text-gray-500 text-base">/ 5.0</span>
                        </p>

                        <p class="text-sm text-gray-500">
                            ({{ organizer_total_reviews }} responden)
                        </p>
                    </div>
                </div>

            </div>

        <!-- === YOUR EVENTS SECTION === -->
        <div class="bg-white shadow rounded-xl border p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Your Event</h2>
                <a href="{% url 'event:create_event' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                    + Create New Event
                </a>
            </div>

                {% if events %}
                    <div class="space-y-4">
                        {% for event in events %}
                        <div class="{% if event.event_status == 'on_going' %} border border-blue-500 
                                    {% elif event.event_status == 'finished' %} border border-green-500 
                                    {% else %} border border-yellow-500 {% endif %} 
                                    rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition">
                            <!-- Header Section -->
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-1">{{ event.name }}</h3>
                                    <p class="text-base text-gray-600">{{ event.get_location_display }}</p>
                                </div>

                                <div class="flex items-center gap-3">
                                    <!-- Status Badge -->
                                    <span class="px-4 py-2 text-sm font-medium rounded-full
                                        {% if event.event_status == 'on_going' %} bg-blue-300 text-blue-700
                                        {% elif event.event_status == 'finished' %} bg-green-300 text-green-700
                                        {% else %} bg-yellow-300 text-yellow-700 {% endif %}">
                                        {% if event.event_status == 'on_going' %}On Going
                                        {% elif event.event_status == 'finished' %}Finished
                                        {% else %}Coming Soon{% endif %}
                                    </span>

                                    <!-- Edit Button -->
                                    <a href="{% url 'event:edit_event' event.id %}" 
                                       class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </a>

        <div id="event-card-list" class="space-y-4 {% if not events %}hidden{% endif %}"></div>
                {% for event in events %}
                <div class="p-5 rounded-xl shadow-md border
                    {% if event.event_status == 'coming_soon' %}
                        bg-yellow-50 border-yellow-200
                    {% elif event.event_status == 'on_going' %}
                        bg-blue-50 border-blue-200
                    {% elif event.event_status == 'finished' %}
                        bg-green-50 border-green-200
                    {% else %}
                        bg-red-50 border-red-200
                    {% endif %}
                ">

                    <!-- TOP ROW -->
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-base font-semibold text-gray-900">{{ event.name }}</h3>
                        </div>

                        <div class="flex items-center gap-2">

                            <!-- STATUS BADGE -->
                            <span class="px-3 py-1 rounded-full text-xs font-semibold
                                {% if event.event_status == 'on_going' %}
                                    bg-blue-100 text-blue-700
                                {% elif event.event_status == 'finished' %}
                                    bg-green-100 text-green-700
                                {% elif event.event_status == 'coming_soon' %}
                                    bg-yellow-100 text-yellow-700
                                {% endif %}
                            ">
                                {{ event.get_event_status_display }}
                            </span>
                            
                            <!-- Edit Button -->
                            <a href="{% url 'event:edit_event' event.id %}?next={{ request.path }}" 
                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </a>
                            
                            <!-- Delete Button -->
                            <form method="POST" action="{% url 'event:delete_event' id=event.id %}" class="delete-event-form inline-block">                                {% csrf_token %}
                                <button type="submit" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    <div>
                                        <p class="text-sm text-gray-500">Total Participants</p>
                                        <p class="text-base font-semibold text-gray-900">{{ event.total_participans }}/{{ event.capacity }} participants</p>
                                    </div>
                                </div>

                            <!-- EDIT hanya untuk On Going -->
                            {% if event.event_status == 'on_going' or event.event_status == 'coming_soon'%}
                            <a href="{% url 'event:edit_event' event.id %}" class="p-1.5 hover:bg-gray-200 rounded-md">âœï¸</a>
                            {% endif %}

                            <!-- DELETE -->
                            <form action="{% url 'event:delete_event' event.id %}" method="POST" class="delete-event-form">
                                {% csrf_token %}
                                <button type="submit" class="p-1.5 hover:bg-red-200 rounded-md text-red-600">ğŸ—‘</button>
                            </form>
                        </div>
                    </div>

                    <!-- DETAILS (4 BARIS SELALU) -->
                    <div class="mt-5 space-y-2 text-sm text-gray-700">
                        <p><span class="font-medium">ğŸ‘¥ Total Participants:</span> {{ event.total_participans|default:"0" }}</p>
                        <p><span class="font-medium">ğŸ“… Date:</span> {{ event.event_date|date:"d M Y (D)" }}</p>
                        <p><span class="font-medium">ğŸ“ Location:</span> {{ event.location }}</p>
                        <p class="text-sm text-gray-700">
                        ğŸ·ï¸ Run Types:
                        {% for cat in event.event_category.all %}
                            {{ cat.get_category_display }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            -
                        {% endfor %}
                        </p>
                    </div>

                    <!-- BUTTON VIEW DETAILS (RIGHT BOTTOM) -->
                    <div class="mt-6 flex justify-end">
                        <a href="{% url 'event:show_event' event.id %}" class="text-sm text-gray-700 hover:text-gray-900 font-medium flex items-center gap-1">
                            View Details â†’
                        </a>
                    </div>

                </div>
                {% endfor %}
            </div>

            {% else %}
            <div class="text-center py-16">
                <h3 class="text-sm font-medium text-gray-900">No events yet</h3>
                <p class="mt-1 text-sm text-gray-500">Create your first event now</p>
            </div>
            {% endif %}
        </div>

    </main>
    
</div>
{% include 'footer.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteForms = document.querySelectorAll('.delete-event-form');

    deleteForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); 

            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }

            const form = this;
            const url = form.action;
            const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            const eventCard = form.closest('.event-card');
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    eventCard.style.transition = 'opacity 0.4s ease';
                    eventCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        eventCard.remove(); 
                        const remainingCards = document.querySelectorAll('.event-card');
                        if (remainingCards.length === 0) {
                            const cardList = document.getElementById('event-card-list');
                            if (cardList) {
                                cardList.classList.add('hidden');
                            }
                            const noEventsMessage = document.getElementById('no-events-message');
                            if (noEventsMessage) {
                                noEventsMessage.classList.remove('hidden');
                            }
                        }

                    }, 400); 
                } else {
                    alert('Error from server: ' + data.error);
                    submitButton.disabled = false; 
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('An error occurred while deleting the event.');
                submitButton.disabled = false; 
            });
        });
    });
});
</script>

{% endblock %}
