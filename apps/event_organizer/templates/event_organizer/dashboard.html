{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Dashboard</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex flex-col bg-gray-50">

    <main class="flex-grow">
        <div class="max-w-7xl mx-auto px-6 py-8 space-y-10 pt-20">

            <!-- === PROFILE SECTION === -->
            <div class="bg-white shadow rounded-xl border p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-5">
                        {% if organizer.profile_picture %}
                            <img src="{{ organizer.profile_picture }}" class="w-20 h-20 object-cover rounded-full border">
                        {% else %}
                            <img src="{% static 'images/logo-img.png' %}" class="w-20 h-20 object-cover rounded-full border">
                        {% endif %}

                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-gray-600">
                            <div>
                                <p class="text-sm text-gray-500">Event Organizer</p>
                                <h1 class="text-4xl font-semibold text-gray-800">{{ organizer.name }}</h1>

                                <div class="mt-2 text-sm text-gray-600 space-y-1">
                                    <p>ğŸŸï¸ Total Events: <span class="font-medium">{{ total_events }}</span></p>
                                    <p>ğŸ“… Joined: <span class="font-medium">{{ organizer.created_at|date:"d M Y" }}</span></p>
                                    <p>ğŸ“ Base Location: <span class="font-medium">{{ organizer.get_base_location_display|default:"-" }}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border rounded-lg w-32 h-24 flex flex-col justify-center items-center">
                        <p class="text-3xl font-bold">{{ total_events }}</p>
                        <p class="text-sm text-gray-600">Events</p>
                    </div>
                </div>

                <hr class="border-gray-200" />

                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Review & Rating</h2>

                    <div class="flex items-center gap-3 text-gray-800">
                        <svg class="w-6 h-6 text-lime-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.955a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.372 2.453a1 1 0 00-.364 1.118l1.286 3.955c.3.921-.755 1.688-1.54 1.118L10 14.347l-3.377 2.479c-.784.57-1.838-.197-1.539-1.118l1.285-3.955a1 1 0 00-.364-1.118L3.63 9.382c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69l1.286-3.955z"/>
                        </svg>
                        <p class="text-xl font-semibold">
                            {{ organizer_average_rating|default:"0.0" }}
                            <span class="text-gray-500 text-base">/ 5.0</span>
                        </p>
                        <p class="text-sm text-gray-500">
                            ({{ organizer_total_reviews }} responden)
                        </p>
                    </div>
                </div>
            </div>

            <!-- === YOUR EVENTS SECTION === -->
            <div class="bg-white shadow rounded-xl border p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">Your Event</h2>
                    <a href="{% url 'event:create_event' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                        + Create New Event
                    </a>
                </div>

                {% if events %}
                <div id="event-card-list" class="event-card-list space-y-6">
                    {% for event in events %}
                    <div class="event-card p-5 rounded-xl shadow-md border
                        {% if event.event_status == 'coming_soon' %}
                            bg-yellow-50 border-yellow-200
                        {% elif event.event_status == 'on_going' %}
                            bg-blue-50 border-blue-200
                        {% elif event.event_status == 'finished' %}
                            bg-green-50 border-green-200
                        {% else %}
                            bg-red-50 border-red-200
                        {% endif %}
                    ">

                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-base font-semibold text-gray-900">{{ event.name }}</h3>
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                    {% if event.event_status == 'on_going' %}
                                        bg-blue-100 text-blue-700
                                    {% elif event.event_status == 'finished' %}
                                        bg-green-100 text-green-700
                                    {% elif event.event_status == 'coming_soon' %}
                                        bg-yellow-100 text-yellow-700
                                    {% endif %}
                                ">
                                    {{ event.get_event_status_display }}
                                </span>

                                {% if event.event_status == 'on_going' or event.event_status == 'coming_soon' %}
                                <a href="{% url 'event:edit_event' event.id %}" class="p-1.5 hover:bg-gray-200 rounded-md">âœï¸</a>
                                {% endif %}

                                <form action="{% url 'event:delete_event' event.id %}" method="POST" class="delete-event-form">
                                    {% csrf_token %}
                                    <button type="submit" class="p-1.5 hover:bg-red-200 rounded-md text-red-600">ğŸ—‘</button>
                                </form>
                            </div>
                        </div>

                        <div class="mt-5 space-y-2 text-sm text-gray-700">
                            <p><span class="font-medium">ğŸ‘¥ Total Participants:</span> {{ event.total_participans|default:"0" }}</p>
                            <p><span class="font-medium">ğŸ“… Date:</span> {{ event.event_date|date:"d M Y (D)" }}</p>
                            <p><span class="font-medium">ğŸ“ Location:</span> {{ event.get_location_display }}</p>
                            <p>ğŸ·ï¸ Run Types:
                                {% for cat in event.event_category.all %}
                                    {{ cat.get_category_display }}{% if not forloop.last %}, {% endif %}
                                {% empty %}-{% endfor %}
                            </p>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <a href="{% url 'event:show_event' event.id %}" class="text-sm text-gray-700 hover:text-gray-900 font-medium flex items-center gap-1">
                                View Details â†’
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div id="no-events-message" class="text-center py-16">
                    <h3 class="text-sm font-medium text-gray-900">No events yet</h3>
                    <p class="mt-1 text-sm text-gray-500">Create your first event now</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<!-- === CONFIRM DELETE TOAST MODAL === -->
<div id="confirmToast" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-[380px] text-center animate-fadeIn">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">Delete this event?</h2>
    <p class="text-gray-500 mb-6 text-sm">This action cannot be undone. Please confirm.</p>
    <div class="flex justify-center gap-3">
      <button id="cancelToast" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">
        Cancel
      </button>
      <button id="confirmToastYes" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium">
        Yes, delete
      </button>
    </div>
  </div>
</div>

<!-- Toast Notif -->
<div id="toast-message" class="hidden fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let targetForm = null;
  const confirmModal = document.getElementById("confirmToast");
  const cancelBtn = document.getElementById("cancelToast");
  const confirmBtn = document.getElementById("confirmToastYes");
  const toast = document.getElementById("toast-message");

  document.querySelectorAll(".delete-event-form").forEach(form => {
    form.addEventListener("submit", e => {
      e.preventDefault();
      targetForm = form;
      confirmModal.classList.remove("hidden");
    });
  });

  cancelBtn.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
  });

  confirmBtn.addEventListener("click", async () => {
    if (!targetForm) return;
    confirmModal.classList.add("hidden");
    const url = targetForm.action;
    const csrftoken = targetForm.querySelector('[name=csrfmiddlewaretoken]').value;
    const eventCard = targetForm.closest(".event-card");
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      }
    });
    const data = await response.json();
    if (data.success) {
      showToast("Event deleted successfully!", true);
      eventCard.style.transition = "opacity 0.4s ease";
      eventCard.style.opacity = "0";
      setTimeout(() => eventCard.remove(), 400);
    } else {
      showToast(data.error || "Failed to delete event.", false);
    }
  });

  function showToast(message, success = true) {
    toast.textContent = message;
    toast.className =
      "fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 transition-opacity duration-300 " +
      (success ? "bg-green-500" : "bg-red-500");
    toast.classList.remove("hidden");
    toast.style.opacity = "0";
    setTimeout(() => (toast.style.opacity = "1"), 50);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.classList.add("hidden"), 300);
    }, 2000);
  }
});
</script>

{% include 'footer.html' %}
{% endblock %}
