{% extends 'base.html' %}

{% block meta %}
<title>Change Password - Spot Runner</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-8 px-4 shadow-lg sm:rounded-lg sm:px-10">
            <h2 class="text-center text-3xl font-bold text-gray-900">Change Password</h2>
            <p class="mt-2 text-center text-sm text-gray-600 mb-6">
                Update your account password
            </p>

            <form method="POST" action="{% url 'event_organizer:change_password' %}" class="space-y-6">
                {% csrf_token %}
                
                <div>
                    <label for="old_password" class="block text-sm font-medium text-gray-700">Current Password</label>
                    <div class="mt-1">
                        <input 
                            id="old_password"
                            name="old_password"
                            type="password"
                            required
                            class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your current password">
                    </div>
                </div>

                <div>
                    <label for="new_password1" class="block text-sm font-medium text-gray-700">New Password</label>
                    <div class="mt-1">
                        <input 
                            id="new_password1" 
                            name="new_password1" 
                            type="password" 
                            required 
                            class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your new password">
                    </div>
                </div>

                <div>
                    <label for="new_password2" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <div class="mt-1">
                        <input 
                            id="new_password2" 
                            name="new_password2" 
                            type="password" 
                            required 
                            class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Confirm your new password">
                    </div>
                </div>

                <div>
                    <button 
                        type="submit" 
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                        Change Password
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <a href="{% url 'event_organizer:profile' %}" class="font-medium text-blue-600 hover:text-blue-500">
                    Back to Profile
                </a>
            </div>

            <!-- Confirm Toast Modal (same theme as edit_profile) -->
            <div id="confirmToast" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
                <div class="bg-white rounded-xl shadow-xl p-6 w-[380px] text-center animate-fadeIn">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Are you sure you want to change your password?</h2>
                    <p class="text-gray-500 mb-6 text-sm">
                    Please confirm that your current password is correct and new passwords match.
                    </p>
                    <div class="flex justify-center gap-3">
                    <button id="cancelToast" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">
                        Cancel
                    </button>
                    <button id="confirmToastYes" class="px-4 py-2 rounded-lg bg-lime-500 hover:bg-lime-600 text-white font-medium">
                        Yes, Iâ€™m sure
                    </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-success" class="hidden fixed top-20 right-5 flex items-center w-full max-w-xs p-4 mb-4 text-white bg-green-500 rounded-lg shadow" role="alert">
  <div class="ms-3 text-sm font-normal">Success!</div>
</div>
<div id="toast-danger" class="hidden fixed top-20 right-5 flex items-center w-full max-w-xs p-4 mb-4 text-white bg-red-500 rounded-lg shadow" role="alert">
  <div class="ms-3 text-sm font-normal">Error!</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("form");
  const toastModal = document.getElementById("confirmToast");
  const cancelBtn = document.getElementById("cancelToast");
  const confirmBtn = document.getElementById("confirmToastYes");

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    toastModal.classList.remove("hidden");
  });

  cancelBtn.addEventListener("click", () => {
    toastModal.classList.add("hidden");
  });

  confirmBtn.addEventListener("click", async () => {
    toastModal.classList.add("hidden");

    const oldPassword = document.getElementById("old_password").value;
    const newPassword1 = document.getElementById("new_password1").value;
    const newPassword2 = document.getElementById("new_password2").value;

    // Check input sebelum kirim
    if (!oldPassword || !newPassword1 || !newPassword2) {
      showToast("All fields are required.", false);
      return;
    }

    if (newPassword1 !== newPassword2) {
      showToast("New password and confirmation do not match.", false);
      return;
    }

    try {
      const formData = new FormData(form);
      const response = await fetch("{% url 'event_organizer:change_password' %}", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        showToast("Password changed successfully!", true);
        setTimeout(() => {
          window.location.href = "{% url 'event_organizer:profile' %}";
        }, 1200);
      } else {
        showToast(data.message || "Failed to change password.", false);
      }
    } catch (error) {
      console.error(error);
      showToast("An error occurred. Please try again.", false);
    }
  });

  // ðŸ”¹ Toast kecil pojok kanan atas
  function showToast(message, success = true) {
    const toast = document.createElement("div");
    toast.className =
      "fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 transition-opacity duration-300 " +
      (success ? "bg-green-500" : "bg-red-500");

    toast.textContent = message;
    document.body.appendChild(toast);

    toast.style.opacity = 0;
    setTimeout(() => (toast.style.opacity = 1), 50);
    setTimeout(() => {
      toast.style.opacity = 0;
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
});
</script>

{% endblock content %}
