{% load static %}
{# expects: event (object), request (available), optional: show_actions True/False #}

<div class="bg-white rounded-xl shadow overflow-hidden relative flex flex-col h-full event-card">

  <!-- IMAGE / HERO AREA -->
  <div class="relative w-full h-44 md:h-48 bg-gray-100">
    {% if event.image %}
      <img src="{{ event.image }}" alt="{{ event.name }}" class="w-full h-full object-cover" />

    {% else %}
      <div class="w-full h-full bg-gray-200 flex items-center justify-center">
        <svg class="w-16 h-16 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7M8 7V5a4 4 0 0 1 8 0v2M5 11h14" />
        </svg>
      </div>
    {% endif %}

    <!-- STATUS BADGE -->
    <div class="absolute top-3 right-3">
      {% if event.event_status == 'coming_soon' %}
        <span class="px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded-full shadow-md">
          Coming Soon
        </span>
      {% elif event.event_status == 'ongoing' %}
        <span class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full shadow-md">
          On Going
        </span>
      {% elif event.event_status == 'finished' %}
        <span class="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-full shadow-md">
          Finished
        </span>
      {% endif %}
    </div>
  </div>

  <!-- CONTENT -->
  <div class="p-5 flex-1 flex flex-col">
    <!-- TITLE & ACTION BUTTONS -->
    <div class="flex items-start justify-between gap-2 mb-3">
      <h3 class="text-lg font-bold text-gray-900 line-clamp-2 hover:text-blue-600 transition-colors flex-1">
        <a href="{% url 'event:show_event' event.id %}">{{ event.name }}</a>
      </h3>

      <!-- ACTION BUTTONS (only for owner) -->
      {% if request.user.is_authenticated %}
        {% if event.user_eo %}
          {% if request.user == event.user_eo.user %}
            <div class="flex items-center gap-2 flex-shrink-0">
              <a href="{% url 'event:edit_event' event.id %}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50" title="Edit">
                <svg class="w-4 h-4 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536M4 20h4.586a1 1 0 0 0 .707-.293l8.414-8.414a1 1 0 0 0 0-1.414L14.121 6.343a1 1 0 0 0-1.414 0L4 15.048V20z"/>
                </svg>
              </a>

              <!-- Delete button dengan class untuk JavaScript -->
              <button type="button" 
                      class="delete-event-btn inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-red-50" 
                      title="Delete"
                      data-event-id="{{ event.id }}"
                      data-event-name="{{ event.name }}"
                      data-delete-url="{% url 'event:delete_event' event.id %}"
                      data-csrf-token="{{ csrf_token }}">
                <svg class="w-4 h-4 text-rose-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3" />
                </svg>
              </button>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>

    <!-- LOCATION -->
    <div class="flex items-center text-gray-600 text-sm mb-2">
      <svg class="w-4 h-4 mr-1.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <span class="truncate">{{ event.get_location_display }}</span>
    </div>

    <!-- DATE -->
    <div class="flex items-center text-gray-600 text-sm mb-3">
      <svg class="w-4 h-4 mr-1.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <span>{{ event.event_date|date:"d M Y" }}</span>
    </div>

    <!-- CATEGORIES -->
    <div class="flex flex-wrap gap-1.5 mb-4">
      {% for category in event.event_category.all %}
        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-medium rounded">
          {{ category.get_category_display }}
        </span>
      {% endfor %}
    </div>

    <!-- SPACER -->
    <div class="flex-1"></div>

    <!-- FOOTER -->
    <div class="flex items-center justify-between pt-3 border-t border-gray-200 mb-3">
      <div class="flex items-center text-sm text-gray-600">
        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span>{{ event.capacity }} max</span>
      </div>

      <div class="flex items-center text-sm font-semibold text-lime-600">
        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>{{ event.coin }} coins</span>
      </div>
    </div>

    <!-- VIEW DETAILS BUTTON -->
    <a href="{% url 'event:show_event' event.id %}" class="block w-full text-center py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors">
      View Details
    </a>
  </div>
</div>

<!-- === CONFIRM DELETE TOAST MODAL === -->
<div id="confirmToast" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-[380px] text-center animate-fadeIn">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">Delete this event?</h2>
    <p class="text-gray-500 mb-6 text-sm">This action cannot be undone. Please confirm.</p>
    <div class="flex justify-center gap-3">
      <button id="cancelToast" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700">
        Cancel
      </button>
      <button id="confirmToastYes" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium">
        Yes, delete
      </button>
    </div>
  </div>
</div>

<!-- Toast Notif -->
<div id="toast-message" class="hidden fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const confirmModal = document.getElementById("confirmToast");
  const cancelBtn = document.getElementById("cancelToast");
  const confirmBtn = document.getElementById("confirmToastYes");
  const toast = document.getElementById("toast-message");

  let currentEventCard = null;
  let currentDeleteUrl = null;
  let currentCsrfToken = null;

  // Event listener untuk semua tombol delete
  document.addEventListener("click", (e) => {
    if (e.target.closest('.delete-event-btn')) {
      const button = e.target.closest('.delete-event-btn');
      currentEventCard = button.closest('.event-card');
      currentDeleteUrl = button.getAttribute('data-delete-url');
      currentCsrfToken = button.getAttribute('data-csrf-token');
      
      confirmModal.classList.remove("hidden");
    }
  });

  cancelBtn.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
    resetCurrentData();
  });

  confirmBtn.addEventListener("click", async () => {
    if (!currentDeleteUrl || !currentCsrfToken) return;
    
    confirmModal.classList.add("hidden");
    
    try {
      const response = await fetch(currentDeleteUrl, {
        method: "POST",
        headers: {
          "X-CSRFToken": currentCsrfToken,
          "X-Requested-With": "XMLHttpRequest"
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast("Event deleted successfully!", true);
        if (currentEventCard) {
          currentEventCard.style.transition = "opacity 0.4s ease";
          currentEventCard.style.opacity = "0";
          setTimeout(() => currentEventCard.remove(), 400);
        }
      } else {
        showToast(data.error || "Failed to delete event.", false);
      }
    } catch (error) {
      console.error("Delete error:", error);
      showToast("An error occurred while deleting the event.", false);
    } finally {
      resetCurrentData();
    }
  });

  function resetCurrentData() {
    currentEventCard = null;
    currentDeleteUrl = null;
    currentCsrfToken = null;
  }

  function showToast(message, success = true) {
    toast.textContent = message;
    toast.className =
      "fixed top-20 right-5 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 transition-opacity duration-300 " +
      (success ? "bg-green-500" : "bg-red-500");
    toast.classList.remove("hidden");
    toast.style.opacity = "0";
    setTimeout(() => (toast.style.opacity = "1"), 50);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.classList.add("hidden"), 300);
    }, 2000);
  }
});
</script>