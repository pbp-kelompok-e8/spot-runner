{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block meta %} {% endblock meta %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/global.css' %}"/>
  </head>
  <body class="bg-[#F9F9F9]">
    {% include 'navbar.html' %}

    <main class="flex-1 pt-16">
      {% block content %}
      {% endblock content %}
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container"
        class="fixed top-20 right-5 z-50 flex flex-col space-y-3">
      {% include 'toast.html' %}
    </div>

    <!-- Scripts -->
    <script src="{% static 'js/toast.js' %}"></script>
    
    <!-- Review Modal Script -->
    <script>
      console.log('Review modal script loading...');

      document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing review modal...');

        const reviewModal = document.getElementById('reviewModal');
        const cancelModalBtn = document.getElementById('cancelModal');
        const errorMessage = document.getElementById('errorMessage');
        const form = document.getElementById('reviewForm');
        const modalEventId = document.getElementById('modal_event_id');
        const modalEventName = document.getElementById('modal_event_name');

        console.log('Modal element:', reviewModal);

        if (!reviewModal) {
          console.error('Review modal not found in DOM!');
          return;
        }

        // Cari semua tombol rate
        const rateButtons = document.querySelectorAll('.rate-event-btn');
        console.log('Found rate buttons:', rateButtons.length);
        
        if (rateButtons.length === 0) {
          console.warn('No rate buttons found!');
        }

        rateButtons.forEach((button, index) => {
          console.log(`Attaching listener to button ${index + 1}`);
          button.addEventListener('click', function (e) {
            e.preventDefault();
            console.log('✅ Button clicked!');
            
            const eventId = this.getAttribute('data-event-id');
            const eventName = this.getAttribute('data-event-name');
            
            console.log('Event ID:', eventId, 'Event Name:', eventName);
            
            // Set nilai ke modal
            modalEventId.value = eventId;
            modalEventName.value = eventName;
            
            // Buka modal
            reviewModal.style.display = 'flex';
            reviewModal.classList.remove('hidden');
            
            console.log('✅ Modal opened');
          });
        });

        // Tutup modal - Cancel button
        if (cancelModalBtn) {
          cancelModalBtn.addEventListener('click', function () {
            console.log('Closing modal...');
            reviewModal.style.display = 'none';
            reviewModal.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            form.reset();
          });
        }

        // Tutup modal - Click outside
        reviewModal.addEventListener('click', function(e) {
          if (e.target === reviewModal) {
            console.log('Closing modal (clicked outside)...');
            reviewModal.style.display = 'none';
            reviewModal.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            form.reset();
          }
        });

        // Submit form
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          if (errorMessage) errorMessage.classList.add('hidden');

          const formData = new FormData(form);
          const eventId = modalEventId.value;

          console.log('Submitting review for event:', eventId);

          fetch(`/review/create/${eventId}/`, {
            method: 'POST',
            headers: { 
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            console.log('Response:', data);
            if (data.success) {
              // Gunakan toast jika fungsi ada
              if (typeof showToast === 'function') {
                showToast('toast-success', 'Review posted successfully!');
              } else {
                alert('Review posted successfully!');
              }
              
              reviewModal.style.display = 'none';
              reviewModal.classList.add('hidden');
              form.reset();
              
              // Reload halaman setelah 500ms
              setTimeout(() => location.reload(), 500);
            } else {
              if (errorMessage) {
                errorMessage.textContent = data.error || 'Failed to submit review';
                errorMessage.classList.remove('hidden');
              }
            }
          })
          .catch(error => {
            console.error('Error:', error);
            if (errorMessage) {
              errorMessage.textContent = 'An error occurred. Please try again.';
              errorMessage.classList.remove('hidden');
            }
          });
        });
      });
    </script>
    
    <!-- Burger menu script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const burgerBtn = document.getElementById("burger-btn");
        const mobileMenu = document.getElementById("mobile-menu");
        if (!burgerBtn || !mobileMenu) return;

        const bars = burgerBtn.querySelectorAll("span");

        burgerBtn.addEventListener("click", () => {
          mobileMenu.classList.toggle("hidden");
          bars[0].classList.toggle("rotate-45");
          bars[0].classList.toggle("translate-y-2");
          bars[1].classList.toggle("opacity-0");
          bars[2].classList.toggle("-rotate-45");
          bars[2].classList.toggle("-translate-y-2");
        });
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>